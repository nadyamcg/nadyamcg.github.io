#!/usr/bin/env bash
# .git/hooks/pre-commit â€” optional guard to ensure canary updated when staged
set -euo pipefail
file="canary/canary.json"
if git diff --cached --quiet -- "$file"; then
  exit 0
fi
old="$(git show :$file 2>/dev/null || true)"
new="$(cat "$file")"
if command -v jq >/dev/null 2>&1; then
  if [[ -n "$old" ]] && jq -e '.token' >/dev/null 2>&1 <<<"$old"; then
    oldtok="$(jq -r '.token' <<<"$old")"
    newtok="$(jq -r '.token' <<<"$new")"
    oldts="$(jq -r '.last_update' <<<"$old")"
    newts="$(jq -r '.last_update' <<<"$new")"
    if [[ "$oldtok" == "$newtok" || "$oldts" == "$newts" ]]; then
      echo "pre-commit: canary token or timestamp did not change. please refresh." >&2
      exit 1
    fi
  fi
fi
exit 0
